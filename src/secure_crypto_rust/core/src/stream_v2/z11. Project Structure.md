# **Production-grade `stream_v2` project layout**

This layout is **deliberate**:

* minimal compile blast radius
* clean dependency direction
* testability without PyO3 / Tokio
* zero circular imports

---

## ğŸ“‚ `src/stream_v2/` â€” **Final Layout**

```bash
src/stream_v2/
â”‚
â”œâ”€â”€ mod.rs                    # Public faÃ§ade + re-exports
â”‚
â”œâ”€â”€ core.rs                   # encrypt_stream_v2 / decrypt_stream_v2
â”‚                             # (stable, public API)
â”‚
â”œâ”€â”€ io.rs                     # InputSource / OutputSink
â”‚                             # ordered writer / reader normalization
â”‚
â”œâ”€â”€ pipeline.rs               # Thread-pool wiring (no crypto)
â”‚
â”œâ”€â”€ segment_worker/           # SEGMENT = unit of parallelism
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ types.rs              # SegmentInput / EncryptedSegment / DecryptedSegment
â”‚   â”œâ”€â”€ crypto.rs             # SegmentCryptoContext (keys, header, nonce policy)
â”‚   â”œâ”€â”€ encrypt.rs            # EncryptSegmentWorker
â”‚   â”œâ”€â”€ decrypt.rs            # DecryptSegmentWorker
â”‚   â””â”€â”€ tests.rs              # segment worker tests (FAST)
â”‚
â”œâ”€â”€ frame_worker/             # FRAME = unit inside segment
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ types.rs              # FrameInput / FrameOutput
â”‚   â”œâ”€â”€ encrypt.rs            # EncryptFrameWorker
â”‚   â”œâ”€â”€ decrypt.rs            # DecryptFrameWorker
â”‚   â””â”€â”€ tests.rs              # frame-level tests
â”‚
â”œâ”€â”€ framing/                  # Wire format (NO CRYPTO)
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ types.rs              # FrameHeader / FrameRecord / FrameError
â”‚   â”œâ”€â”€ encode.rs
â”‚   â”œâ”€â”€ decode.rs
â”‚   â””â”€â”€ tests.rs              # framing invariants
â”‚
â””â”€â”€ tests/
    â””â”€â”€ roundtrip.rs          # Full v2 encrypt â†’ decrypt (single thread)
```

---

## ğŸ§­ Dependency Direction (STREAM_V2)

```text
headers
   â†‘
crypto
   â†‘
stream_v2
```

## ğŸ§­ Dependency Direction (CRITICAL)

```text
framing
   â†‘
frame_worker
   â†‘
segment_worker
   â†‘
pipeline
   â†‘
core
```

âœ” **Never inverted**
âœ” **No shared mutable state**
âœ” **Crypto only appears at frame/segment worker level**

---

## ğŸ“¦ `mod.rs` (example)

```rust
// src/stream_v2/mod.rs

pub mod core;
pub mod io;
pub mod pipeline;

pub mod framing;
pub mod frame_worker;
pub mod segment_worker;

pub use core::{encrypt_stream_v2, decrypt_stream_v2};
```

---

## ğŸ” Segment Worker Responsibilities

| File         | Responsibility                 |
| ------------ | ------------------------------ |
| `types.rs`   | Pure data structures           |
| `crypto.rs`  | Key derivation, nonce strategy |
| `encrypt.rs` | Segment â†’ encrypted wire       |
| `decrypt.rs` | Wire â†’ plaintext frames        |
| `tests.rs`   | Deterministic correctness      |

No IO.
No threads.
No channels.

---

## ğŸ§ª Why This Layout Compiles Fast

* Tests donâ€™t pull in:

  * PyO3
  * Tokio
  * async
* `segment_worker/tests.rs` touches **<15 files**
* `cargo test segment_worker` is seconds after first build

---

## ğŸ§  Why This Is the *Correct* Architecture

This matches **industrial streaming engines**:

| System      | Unit             |
| ----------- | ---------------- |
| NVMe        | submission queue |
| Kafka       | batch            |
| RocksDB     | SST block        |
| Our system  | **segment**      |

We are **not guessing** â€” weâ€™re converging on proven design.

---
