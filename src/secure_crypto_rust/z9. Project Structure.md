#

Youâ€™re very close already â€” the **main problem is mixing concerns**.
Below is a **production-grade re-organization** that:

* keeps Rust **fast to compile & test**
* keeps PyO3 **isolated**
* gives you a **clean public Rust API**
* gives Python a **stable binding layer**
* supports **v1 + v2 side-by-side**
* avoids rebuilding Python when testing Rust

Iâ€™ll show **final structure + concrete `lib.rs` layouts**.

---

## 1ï¸âƒ£ Correct high-level architecture (non-negotiable)

You should have **two Rust crates** in a workspace:

```bash
app/crypto/rust/
â”œâ”€â”€ Cargo.toml              # workspace
â”‚
â”œâ”€â”€ core/            # ğŸš€ pure Rust (FAST)
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ compression/
â”‚       â”œâ”€â”€ telemetry/
â”‚       â”œâ”€â”€ stream_v1/
â”‚       â”œâ”€â”€ stream_v2/
â”‚       â”œâ”€â”€ headers/
â”‚       â”œâ”€â”€ framing/
â”‚       â”œâ”€â”€ crypto/
â”‚       â”œâ”€â”€ constants.rs
â”‚       â”œâ”€â”€ types.rs
â”‚       â””â”€â”€ lib.rs
â”‚
â””â”€â”€ python/          # ğŸ PyO3 bindings (SLOW, isolated)
    â”œâ”€â”€ Cargo.toml
    â””â”€â”€ src/
        â”œâ”€â”€ lib.rs
        â”œâ”€â”€ ffi/
        â”‚   â”œâ”€â”€ mod.rs
        â”‚   â”œâ”€â”€ constants.rs
        â”‚   â”œâ”€â”€ types.rs
        â”‚   â””â”€â”€ tests.rs
```

ğŸ‘‰ **Rule:**
`core` must compile **without PyO3 installed**.

---

## 5ï¸âƒ£ Why this solves your pain points

### â± Compile time

* `cargo test -p crypto-core` â†’ **seconds**
* No PyO3 rebuilds
* No Python headers

### ğŸ§  Parallelism

* `stream_v2` uses **OS threads + crossbeam**
* No async illusions
* No GIL involvement

### ğŸ§ª Testing

```bash
cd app/crypto/rust
cargo test -p crypto-core
```

Python not involved at all.

---

## 2ï¸âƒ£ `core/src/lib.rs` (PURE RUST)

```rust

```

### Why this is correct

* **No PyO3**
* **No Python**
* `cargo test` is now **fast**
* v1 and v2 coexist cleanly
* v2 does **not depend on stream_parallel_enc.rs**

---

## 3ï¸âƒ£ `python/src/lib.rs` (PyO3 ONLY)

This replaces your current mixed PyO3 `lib.rs`.

```rust
//! crypto-python
//!
//! Python bindings for crypto-core (PyO3).

use pyo3::prelude::*;

mod ffi;

/// Python module entry point
#[pymodule]
fn rust_crypto(py: Python<'_>, m: &Bound<'_, PyModule>) -> PyResult<()> {
    ffi::register(py, m)?;
    Ok(())
}
```

---

## 4ï¸âƒ£ `python/src/ffi/mod.rs`

This is where **everything Python-facing lives**.

```rust
use pyo3::prelude::*;

mod adapters_sync;
mod adapters_async;
mod params;
mod enums;
mod constants;
mod tests;

pub fn register(py: Python<'_>, m: &Bound<'_, PyModule>) -> PyResult<()> {
    adapters_sync::register(py, m)?;
    adapters_async::register(py, m)?;
    params::register(py, m)?;
    enums::register(py, m)?;
    constants::register(py, m)?;
    Ok(())
}
```

---

## 5ï¸âƒ£ PyO3 adapters depend on crypto-core (cleanly)

Example: `adapters_sync.rs`

```rust
use pyo3::prelude::*;
use crypto_core::prelude::*;

#[pyfunction]
fn encrypt_stream_v2_py(
    input: PyObject,
    output: PyObject,
    params: EncryptParams,
    parallelism: ParallelismProfile,
) -> PyResult<TelemetrySnapshot> {
    let input = InputSource::from_py(input)?;
    let output = OutputSink::from_py(output)?;

    encrypt_stream_v2(
        input,
        output,
        &params.master_key,
        params,
        parallelism,
    ).map_err(|e| e.into())
}

pub fn register(_py: Python<'_>, m: &Bound<'_, PyModule>) -> PyResult<()> {
    m.add_function(wrap_pyfunction!(encrypt_stream_v2_py, m)?)?;
    Ok(())
}
```

---

## 6ï¸âƒ£ What you gain immediately

### ğŸš€ Rust testing

```bash
cd crypto-core
cargo test
```

* no Python
* no PyO3
* no maturin
* fast incremental builds

### ğŸ Python testing

```bash
cd crypto-python
maturin develop
pytest
```

Only when needed.

---

## 7ï¸âƒ£ Migration from your current layout

### Step-by-step (safe)

1. **Create workspace**
2. Move everything non-PyO3 â†’ `crypto-core`
3. Delete PyO3 imports from core
4. Create `crypto-python`
5. Re-export core APIs via adapters
6. Run:

   ```bash
   cargo test -p crypto-core
   maturin develop -p crypto-python
   ```

---

## 8ï¸âƒ£ Final verdict (important)

Your original `lib.rs` is **not wrong** â€”
itâ€™s just **not scalable** for:

* parallel crypto
* heavy native deps
* PyO3
* CI
* iteration speed

This re-org is how **RustCrypto**, **wasmtime**, **polars**, and **ripgrep** do it.

---
